clear
clc

q_in1 = [0.95368782 -0.51877292 -1.45972500 1.15138021 1.82099954 -1.32884872 -0.53357757 -2.35525825 -2.00279978 -0.18217448 -2.01122240 -0.72188989 0.09822164 -0.69214399 0.35997167 -0.22257033 -0.88548613 0.23375033 0.15823299 -0.90739414 0.10729779 1.60077628 0.36409125 -0.63556657 -1.55261971; 2.01019625 -0.57846593 -1.11835944 -0.94491534 -0.18670970 -0.48605867 0.31936122 -0.80015317 -0.05532229 1.14955046 1.15910315 0.05765190 -0.17856967 0.96355855 -0.62269836 -0.93043990 0.48703797 -0.57474732 0.06527235 -1.24674527 1.42588516 0.73338800 -0.96607546 0.31318968 1.33674916; 0.21722855 -0.01488591 0.78760658 -0.39506273 1.16489124 1.50530706 2.09103940 1.78173318 -1.28322178 1.50362527 0.39512749 0.77586377 0.00429055 -0.67187240 0.70196394 0.31600108 0.78890334 -0.51762806 1.75637203 0.80113097 2.58116784 0.53032111 0.87033234 0.33594640 1.06427628; 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000];
q_in0 = [2.16952632 -0.67490668 -2.43149916 1.16423375 1.57551261 -0.71958903 -0.85782781 -2.55855592 -3.05492071 0.53219341 -1.29612741 0.56951497 0.14189914 -1.08221217 0.90154577 -1.12325315 0.07406971 0.35403533 0.79497290 -1.01054742 -0.24771121 1.12852125 0.03883339 -0.27934857 -1.41356102; 2.09580690 0.31468430 -0.29068240 0.29382670 -0.05022869 -1.09370214 -0.39732871 -0.28921563 1.12779336 0.83355542 1.10889837 0.06255333 0.78532547 1.12045289 -0.41378591 -1.44456780 0.37766235 -0.17034934 -0.88762590 -0.61473207 0.40442033 0.48495710 -1.47298954 0.83874343 1.73077719; 1.36210979 -0.56178183 -0.85188321 -1.84889828 0.15488779 0.60073217 0.70755012 0.90544207 -1.56166291 1.93571132 0.00881285 0.45205375 -0.14696733 -0.68804287 -0.37501531 -1.07574729 0.32358887 -1.99820780 1.39564298 -1.09837539 2.67792953 0.27254959 -1.88432785 0.76339482 1.69171585; 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000];

%Initial guesses
error = 30;
u = ones(6,1);
M = [0.75205231 -0.43261543 -0.49725366 -0.49165623; 0.054722049 0.79281793 -0.60699689 0.067904981; 0.65682784 0.42928268 0.61991416 0.72101482; 0 0 0 1];
mu = 0.001;
while error > 0.01
    u = 0.001*u;
	J = zeros(6,6);
	b = zeros(6,1);
    for i = 1:25
        b_i = q_in0(:,i) - expm(skew4(u))*M*q_in1(:,i);
    	A = eye(6); %Used to get delta_j (which is just a basis vector for the jth dimension)
    	J_i = [];
        for j = 1:6 
        	J_i = [J_i skew4(A(:,j))*M*q_in1(:,i)];
        end
        J = J + J_i'*J_i;
        b = b + J_i'*b_i;
    end
    u = inv(J + mu*eye(6))*b;
    M = expm(skew4(u))*M;
    error = norm(u)
end	
M